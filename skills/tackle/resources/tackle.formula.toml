description = """
Upstream-aware issue implementation workflow with approval gates.

Tracks work from initial research through PR submission. Each step is a
checkpoint that survives session restarts. Gates require explicit approval.
"""
formula = "tackle"
version = 1

[vars.issue]
description = "The issue ID being tackled"
required = true

[vars.upstream]
description = "Detected upstream org/repo"
required = false

[[steps]]
id = "bootstrap"
title = "Bootstrap upstream research"
description = """
See RESEARCH.md Sections 1-5.

1. Pre-flight checks (gh auth, git remotes, issue exists)
2. Detect upstream from git remotes (upstream > fork-source > origin)
3. Detect default branch
4. Check research cache freshness (>24h = stale)
5. If stale, refresh: CONTRIBUTING.md, PR patterns, open issues
6. Discover related upstreams from README
"""

[[steps]]
id = "gate-bootstrap"
title = "GATE: Research review"
needs = ["bootstrap"]
description = """
**CHECKPOINT** (appears when research cache updated)

Present research summary and any related upstream suggestions.
User can add related upstreams or skip.

See SKILL.md bootstrap gate section for presentation format.
"""

[[steps]]
id = "context"
title = "Search upstream for related work"
needs = ["gate-bootstrap"]
description = """
See RESEARCH.md Section 6.

Fuzzy search upstream for:
- Issues with similar keywords/titles
- Open PRs addressing related problems
- Recently merged PRs in same area
- Recent commits ahead of our fork

Output: Contextual information (NOT suggestions to work on)
"""

[[steps]]
id = "existing-pr-check"
title = "Check for existing fix PR"
needs = ["context"]
description = """
See RESEARCH.md Section 7.

If a highly-relevant open PR exists that would fix our issue:
1. Present options (natural language accepted)
2. If apply-pr: fetch, test locally, close if passes
3. If wait-upstream: mark blocked, track PR status
4. If implement-anyway: continue to plan
"""

[[steps]]
id = "plan"
title = "Create implementation plan"
needs = ["existing-pr-check"]
description = """
See IMPLEMENT.md Plan Phase.

Create implementation plan based on:
- Issue requirements
- Upstream context (patterns, conventions)
- Hot areas to avoid
"""

[[steps]]
id = "gate-plan"
title = "GATE: Plan approval"
needs = ["plan"]
description = """
**MANDATORY STOP**

Present plan to user. Wait for explicit approval:
  /tackle --gate approve
  /tackle --gate reject

DO NOT PROCEED WITHOUT APPROVAL.
See SKILL.md gate-plan section.
"""

[[steps]]
id = "branch"
title = "Create clean branch"
needs = ["gate-plan"]
description = """
See IMPLEMENT.md Branch Phase.

git fetch upstream
git checkout -b <type>/<issue-id>-<description> upstream/$DEFAULT_BRANCH

Use default branch from RESEARCH.md Section 2.
"""

[[steps]]
id = "implement"
title = "Implement solution"
needs = ["branch"]
description = """
See IMPLEMENT.md Implement Phase.

Implement following upstream conventions.
Commit atomically with conventional commit messages.
"""

[[steps]]
id = "validate"
title = "Validate implementation"
needs = ["implement"]
description = """
See VALIDATION.md.

- Run tests
- Check isolation (single concern)
- Verify branch is rebased on upstream
"""

[[steps]]
id = "gate-submit"
title = "GATE: Pre-submit approval"
needs = ["validate"]
description = """
**MANDATORY STOP**

On entering this gate:
1. Check if draft PR already exists (idempotent)
2. If not, create draft PR on upstream
3. Present for review

Show full PR preview:
- Draft PR URL on upstream
- Title, body, files changed
- Validation results

Wait for explicit approval:
  /tackle --gate approve
  /tackle --gate reject

DO NOT MARK PR READY WITHOUT APPROVAL.
See SKILL.md gate-submit section.
"""

[[steps]]
id = "submit"
title = "Submit PR"
needs = ["gate-submit"]
description = """
See SUBMIT.md.

Only after explicit approval:
1. Mark draft PR as ready for review: gh pr ready
2. Verify PR is no longer in draft state
"""

[[steps]]
id = "record"
title = "Record outcome"
needs = ["submit"]
description = """
See SUBMIT.md Record Phase.

Track PR URL and outcome for future learning.
Update local issue with PR link.
"""

[[steps]]
id = "retro"
title = "Retrospective"
needs = ["record"]
description = """
See REFLECT.md.

Reflect on issues tackle could help prevent in future runs.

**Fix immediately**: Objective errors (wrong flags, syntax errors).
**Note for pattern detection**: Subjective friction via molecule history.

Ignore task-specific issues (test failures, upstream quirks).
"""
